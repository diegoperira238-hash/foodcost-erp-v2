{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <!-- CABE√áALHO COM INFORMA√á√ïES DO USU√ÅRIO -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">üîß Painel Administrativo</h1>
            <p class="text-muted mb-0">
                Usu√°rio: <strong>{{ session.usuario_nome }}</strong> | 
                Tipo: 
                {% if session.usuario_nome == 'bpereira' %}
                    <span class="badge bg-danger">SUPER ADMIN</span>
                {% elif session.role == 'admin' %}
                    <span class="badge bg-warning">ADMIN</span>
                {% else %}
                    <span class="badge bg-secondary">USU√ÅRIO</span>
                {% endif %}
            </p>
        </div>
        
        <div class="btn-group">
            {% if session.usuario_nome == 'bpereira' %}
            <a href="/admin/master" class="btn btn-danger">
                <i class="fas fa-crown"></i> Painel Master
            </a>
            {% endif %}
            <a href="/admin/historico-chaves" class="btn btn-primary">
                <i class="fas fa-history"></i> Hist√≥rico
            </a>
        </div>
    </div>

    <!-- CARDS DE ESTAT√çSTICAS -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h2>{{ lojas|length }}/10</h2>
                    <p class="mb-0">Lojas</p>
                    <small>
                        {% set lojas_ativas = lojas|selectattr('ativo', 'equalto', true)|list %}
                        {{ lojas_ativas|length }} ativas
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h2>{{ usuarios|length }}</h2>
                    <p class="mb-0">Usu√°rios</p>
                    <small>
                        {% set admins = usuarios|selectattr('role', 'equalto', 'admin')|list %}
                        {{ admins|length }} administradores
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h2>
                        {% if is_super_admin %}
                            {{ lojas|sum(attribute='max_maquinas') or 0 }}
                        {% else %}
                            3
                        {% endif %}
                    </h2>
                    <p class="mb-0">M√°quinas (limite)</p>
                    <small>Gerenciar no menu</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <a href="/admin/historico-chaves" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-history"></i> Hist√≥rico
                    </a>
                    <a href="/maquinas" class="btn btn-info w-100">
                        <i class="fas fa-laptop"></i> M√°quinas
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GERENCIAR LOJAS -->
    <!-- GERENCIAR LOJAS -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">üè™ GERENCIAR LOJAS (LIMITE: 10)</h5>
        <span class="badge bg-{{ 'danger' if lojas|length >= 10 else 'success' }}">
            {{ lojas|length }}/10
        </span>
    </div>
    <div class="card-body">
        {% if is_super_admin %}
        <form method="POST" action="{{ url_for('config_admin') }}" class="mb-3" 
              id="formCriarLoja" onsubmit="return verificarLimite()">
            <input type="hidden" name="tipo_acao" value="add_loja">
            <div class="input-group">
                <input type="text" name="nome_loja" class="form-control" 
                       placeholder="Nome da nova loja" required
                       id="nomeLojaInput">
                <button class="btn btn-{{ 'danger' if lojas|length >= 10 else 'success' }}" 
                        type="submit" id="btnCriarLoja"
                        {{ 'disabled' if lojas|length >= 10 }}>
                    <i class="fas fa-plus"></i> 
                    {{ 'LIMITE ATINGIDO' if lojas|length >= 10 else 'Criar Loja' }}
                </button>
            </div>
            <small class="text-muted d-block mt-1">
                {% if lojas|length >= 10 %}
                <span class="text-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    LIMITE ATINGIDO! N√£o √© poss√≠vel criar mais lojas.
                </span>
                {% else %}
                Limite: {{ lojas|length }}/10 lojas | Vagas: {{ 10 - lojas|length }}
                {% endif %}
            </small>
        </form>
        {% endif %}
        
        <!-- ALERTA DE LIMITE -->
        {% if lojas|length >= 8 %}
        <div class="alert alert-{{ 'danger' if lojas|length >= 10 else 'warning' }} mb-3">
            <i class="fas fa-{{ 'exclamation-triangle' if lojas|length >= 10 else 'info-circle' }}"></i>
            {% if lojas|length >= 10 %}
            <strong>LIMITE M√ÅXIMO ATINGIDO!</strong> 
            Sistema com {{ lojas|length }}/10 lojas. N√£o √© poss√≠vel criar mais.
            {% elif lojas|length >= 9 %}
            <strong>ATEN√á√ÉO!</strong> 
            Sistema com {{ lojas|length }}/10 lojas. Apenas {{ 10 - lojas|length }} vaga dispon√≠vel.
            {% else %}
            <strong>AVISO:</strong> 
            Sistema com {{ lojas|length }}/10 lojas. {{ 10 - lojas|length }} vagas dispon√≠veis.
            {% endif %}
        </div>
        {% endif %}
        
        <!-- ... resto da tabela de lojas continua igual ... -->
    
    <!-- GERENCIAR USU√ÅRIOS -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">üë• GERENCIAR USU√ÅRIOS</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('config_admin') }}" class="mb-3">
                <input type="hidden" name="tipo_acao" value="add_user">
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="text" name="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="col-md-3">
                        <input type="password" name="password" class="form-control" placeholder="Senha" required>
                    </div>
                    <div class="col-md-3">
                        <select name="loja_id" class="form-control">
                            <option value="">Selecionar Loja</option>
                            {% for loja in lojas if loja.ativo %}
                            <option value="{{ loja.id }}">{{ loja.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="role" class="form-control">
                            <option value="user">Usu√°rio</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </form>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Tipo</th>
                            <th>Loja</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in usuarios %}
                        <tr>
                            <td>{{ u.id }}</td>
                            <td>{{ u.username }}</td>
                            <td>
                                {% if u.role == 'admin' %}
                                <span class="badge bg-danger">Admin</span>
                                {% else %}
                                <span class="badge bg-secondary">User</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if u.loja %}
                                {{ u.loja.nome }}
                                {% else %}
                                <span class="text-muted">Sem loja</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <!-- Resetar Senha -->
                                    <button class="btn btn-warning" 
                                            onclick="resetarSenha({{ u.id }}, '{{ u.username }}')"
                                            title="Resetar Senha">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    
                                    <!-- Alternar Admin/User -->
                                    {% if u.id != session.usuario_id %}
                                    <form method="POST" action="{{ url_for('config_admin') }}" class="d-inline">
                                        <input type="hidden" name="tipo_acao" value="toggle_role">
                                        <input type="hidden" name="user_id" value="{{ u.id }}">
                                        <button type="submit" class="btn btn-info" title="Alternar Admin/User">
                                            <i class="fas fa-user-shield"></i>
                                        </button>
                                    </form>
                                    
                                    <!-- Excluir -->
                                    {% if is_super_admin %}
                                    <a href="/excluir/usuario/{{ u.id }}" class="btn btn-danger" 
                                       onclick="return confirm('Excluir usu√°rio {{ u.username }}?')"
                                       title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                                Nenhum usu√°rio encontrado
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- BOT√ïES ADICIONAIS -->
    <div class="card">
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4 mb-2">
                    <a href="/maquinas" class="btn btn-info w-100">
                        <i class="fas fa-laptop"></i> Gerenciar M√°quinas
                    </a>
                </div>
                <div class="col-md-4 mb-2">
                    <a href="/admin/logs/completo" class="btn btn-secondary w-100">
                        <i class="fas fa-clipboard-list"></i> Ver Logs
                    </a>
                </div>
                <div class="col-md-4 mb-2">
                    <a href="/" class="btn btn-primary w-100">
                        <i class="fas fa-home"></i> Voltar ao In√≠cio
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Gerar Nova Chave -->
<div class="modal fade" id="modalGerarChave">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üîë Gerar Nova Chave</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('config_admin') }}">
                <input type="hidden" name="tipo_acao" value="gerar_nova_chave">
                <input type="hidden" id="lojaIdChave" name="loja_id">
                <div class="modal-body">
                    <p>Gerar nova chave para: <strong id="nomeLojaChave"></strong></p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> A chave atual ser√° substitu√≠da!
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Gerar Nova Chave</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Resetar Senha -->
<div class="modal fade" id="modalResetSenha">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üîê Resetar Senha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('config_admin') }}">
                <input type="hidden" name="tipo_acao" value="reset_password">
                <input type="hidden" id="userIdReset" name="user_id">
                <div class="modal-body">
                    <p>Resetar senha para: <strong id="usernameReset"></strong></p>
                    <div class="mb-3">
                        <label>Nova Senha:</label>
                        <input type="password" name="nova_senha" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label>Confirmar Senha:</label>
                        <input type="password" name="confirmar_senha" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function gerarChave(lojaId, lojaNome) {
    document.getElementById('lojaIdChave').value = lojaId;
    document.getElementById('nomeLojaChave').textContent = lojaNome;
    new bootstrap.Modal(document.getElementById('modalGerarChave')).show();
}

function resetarSenha(userId, username) {
    document.getElementById('userIdReset').value = userId;
    document.getElementById('usernameReset').textContent = username;
    new bootstrap.Modal(document.getElementById('modalResetSenha')).show();
}
</script>

<script>
// Verificar limite antes de enviar formul√°rio
function verificarLimite() {
    const totalLojas = {{ lojas|length }};
    const limite = 10;
    
    if (totalLojas >= limite) {
        alert('‚ùå LIMITE ATINGIDO!\n\nO sistema j√° possui o n√∫mero m√°ximo de 10 lojas.\nN√£o √© poss√≠vel criar novas lojas.');
        return false;
    }
    
    return true;
}

// Verificar ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const totalLojas = {{ lojas|length }};
    const limite = 10;
    
    // Atualizar badges
    const badges = document.querySelectorAll('.badge-loja-count');
    badges.forEach(badge => {
        if (totalLojas >= limite) {
            badge.classList.remove('bg-success', 'bg-warning');
            badge.classList.add('bg-danger');
        } else if (totalLojas >= limite - 2) {
            badge.classList.remove('bg-success', 'bg-danger');
            badge.classList.add('bg-warning');
        }
    });
    
    // Mostrar alerta se estiver perto do limite
    if (totalLojas >= limite - 1) {
        console.log(`‚ö†Ô∏è Sistema com ${totalLojas}/${limite} lojas`);
        
        // Adicionar contador no t√≠tulo
        const titulo = document.querySelector('h1');
        if (titulo) {
            const contador = document.createElement('span');
            contador.className = `badge ms-2 bg-${totalLojas >= limite ? 'danger' : 'warning'}`;
            contador.textContent = `${totalLojas}/${limite}`;
            titulo.appendChild(contador);
        }
    }
    
    // Bloquear bot√£o se atingiu limite
    const btnCriarLoja = document.getElementById('btnCriarLoja');
    const nomeLojaInput = document.getElementById('nomeLojaInput');
    
    if (totalLojas >= limite) {
        if (btnCriarLoja) {
            btnCriarLoja.disabled = true;
            btnCriarLoja.innerHTML = '<i class="fas fa-ban"></i> LIMITE ATINGIDO';
        }
        if (nomeLojaInput) {
            nomeLojaInput.disabled = true;
            nomeLojaInput.placeholder = 'Sistema com limite m√°ximo de lojas';
        }
    }
});
</script>
{% endblock %}  
 
 
