{% extends 'base.html' %}
{% block content %}
<div class="card p-4 shadow-sm border-0 bg-white">
    <h4 class="fw-bold mb-4 text-warning">Editar Ficha Técnica: {{ f.nome }}</h4>
    <form method="POST">
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="form-label fw-bold">Nome do Produto</label>
                <input type="text" name="nome" class="form-control" value="{{ f.nome }}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Rendimento (Porções)</label>
                <input type="number" step="0.01" name="porcoes" class="form-control" value="{{ f.porcoes }}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Preço de Venda (R$)</label>
                <input type="number" step="0.01" name="preco_venda" class="form-control" value="{{ f.preco_venda }}" required>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Meta CMV (%)</label>
                <input type="number" step="0.1" name="cmv_alvo" class="form-control" value="{{ f.cmv_alvo }}">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 border-end">
                <h5 class="fw-bold text-primary mb-3">Ingredientes (Insumos)</h5>
                <div id="insumos-container">
                    {% for item in i_items %}
                    <div class="row g-2 mb-2">
                        <div class="col-8">
                            <select name="insumo_id[]" class="form-select">
                                {% for i in insumos %}
                                <option value="{{i.id}}" {{'selected' if i.id == item.item_id}}>{{i.nome}} ({{i.unidade}})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <input type="number" step="0.001" name="insumo_qtd[]" class="form-control" value="{{ item.qtd }}">
                        </div>
                    </div>
                    {% endfor %}
                    <div class="row g-2 mb-2 line-template-ins">
                        <div class="col-8">
                            <select name="insumo_id[]" class="form-select">
                                <option value="">+ Selecione um Insumo...</option>
                                {% for i in insumos %}<option value="{{i.id}}">{{i.nome}}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-4"><input type="number" step="0.001" name="insumo_qtd[]" class="form-control" placeholder="Qtd"></div>
                    </div>
                </div>
                <button type="button" onclick="addLine('insumos-container')" class="btn btn-sm btn-outline-primary mt-2">+ Insumo</button>
            </div>

            <div class="col-md-6">
                <h5 class="fw-bold text-info mb-3">Bases Prontas</h5>
                <div id="bases-container">
                    {% for item in b_items %}
                    <div class="row g-2 mb-2">
                        <div class="col-8">
                            <select name="base_id[]" class="form-select">
                                {% for b in bases %}
                                <option value="{{b.id}}" {{'selected' if b.id == item.item_id}}>{{b.nome}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <input type="number" step="0.001" name="base_qtd[]" class="form-control" value="{{ item.qtd }}">
                        </div>
                    </div>
                    {% endfor %}
                    <div class="row g-2 mb-2 line-template-bas">
                        <div class="col-8">
                            <select name="base_id[]" class="form-select">
                                <option value="">+ Selecione uma Base...</option>
                                {% for b in bases %}<option value="{{b.id}}">{{b.nome}}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-4"><input type="number" step="0.001" name="base_qtd[]" class="form-control" placeholder="Qtd"></div>
                    </div>
                </div>
                <button type="button" onclick="addLine('bases-container')" class="btn btn-sm btn-outline-info mt-2">+ Base</button>
            </div>
        </div>

        <div class="mt-5 border-top pt-4">
            <button type="submit" class="btn btn-warning px-5 fw-bold text-dark">Salvar Alterações</button>
            <a href="/" class="btn btn-light border px-4">Cancelar</a>
        </div>
    </form>
</div>
<script>
function addLine(containerId) {
    const container = document.getElementById(containerId);
    const rows = container.querySelectorAll('.row');
    const lastRow = rows[rows.length - 1];
    const newRow = lastRow.cloneNode(true);
    newRow.querySelectorAll('input').forEach(i => i.value = '');
    newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    container.appendChild(newRow);
}
</script>
{% endblock %}